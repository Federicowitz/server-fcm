<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PrimeGenesis</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 600px;
            margin: auto;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            text-align: center;
            color: #444;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            width: 100%;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #logoutButton {
            background-color: #6c757d;
        }

        #logoutButton:hover {
            background-color: #5a6268;
        }

        .response {
            margin-top: 20px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: none;
        }

        .success {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }

        .welcome-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <!-- Sezione di Login (visibile di default) -->
    <div id="login-section" class="container">
        <h1>Login PrimeGenesis</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginIdentifier">Email o Username</label>
                <input type="text" id="loginIdentifier" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit">Accedi</button>
        </form>
        <div id="login-response" class="response"></div>
    </div>

    <!-- Sezione Transazione (nascosta di default) -->
    <div id="transaction-section" class="container" style="display: none;">
        <div class="welcome-container">
            <h2 style="text-align: left; margin: 0;">Invia Transazione</h2>
            <button type="button" id="logoutButton">Logout</button>
        </div>
        <p id="welcome-message"></p>
        <form id="txForm">
            <input type="hidden" id="userIdentifier">
            <div class="form-group">
                <!-- MODIFICATO: Etichetta e placeholder aggiornati -->
                <label for="recipientIdentifier">Destinatario (Indirizzo Solana, Email o Username)</label>
                <input type="text" id="recipientIdentifier" placeholder="Es: Bx...yZ oppure utente@mail.com" required>
            </div>
            <div class="form-group">
                <label for="amount">Importo (in SOL)</label>
                <input type="number" id="amount" step="0.001" placeholder="Es: 0.1" required>
            </div>
            <button type="submit">Prepara e Invia Richiesta</button>
        </form>
        <div id="tx-response" class="response"></div>
    </div>

    <script>
        // Riferimenti agli elementi del DOM
        const loginSection = document.getElementById('login-section');
        const txSection = document.getElementById('transaction-section');
        const loginForm = document.getElementById('loginForm');
        const txForm = document.getElementById('txForm');
        const loginResponseDiv = document.getElementById('login-response');
        const txResponseDiv = document.getElementById('tx-response');
        const logoutButton = document.getElementById('logoutButton');

        /**
         * NUOVA FUNZIONE: Prepara e mostra la UI per l'utente loggato.
         * Questa funzione viene chiamata sia dopo un login riuscito,
         * sia al caricamento della pagina se troviamo un utente nel localStorage.
         */
        function showTransactionUI(user) {
            // Ora questo funzionerà perché il server invia le proprietà in camelCase
            document.getElementById('welcome-message').textContent = `Benvenuto, ${user.firstName}! Stai inviando dal wallet: ${user.publicKey}`;
            document.getElementById('userIdentifier').value = user.username;
            loginSection.style.display = 'none';
            txSection.style.display = 'block';
        }

        
        // --- LOGICA DI CARICAMENTO PAGINA (MODIFICATA) USA COOKIE ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Prova a chiamare il nuovo endpoint per verificare la sessione
                const response = await fetch('/check-session');
                if (!response.ok) {
                    // Se la risposta non è OK (es. 401), l'utente non è loggato
                    console.log("Sessione non valida o scaduta. Mostro il login.");
                    return;
                }
                // Se la risposta è OK, l'utente è loggato
                const result = await response.json();
                console.log("Sessione valida trovata. Mostro la dashboard.");
                showTransactionUI(result.user);
            } catch (error) {
                console.error("Errore nel controllo della sessione:", error);
            }
        });

        // Gestione del form di Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('loginIdentifier').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                // 2. Chiama la funzione per mostrare la UI corretta
                showTransactionUI(result.user);

            } catch (error) {
                loginResponseDiv.textContent = `Errore: ${error.message}`;
                loginResponseDiv.className = 'response error';
                loginResponseDiv.style.display = 'block';
            }
        });

        // Gestione Invio Transazione (non cambia la logica, solo il nome del bottone)
        txForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    recipientIdentifier: document.getElementById('recipientIdentifier').value,
                    amount: document.getElementById('amount').value,
                };

                txResponseDiv.textContent = 'Invio richiesta in corso...';
                txResponseDiv.className = 'response';
                txResponseDiv.style.display = 'block';

                try {
                    const response = await fetch('/send-transaction-fcm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data) // Inviamo recipientIdentifier
                    });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.message);

                    txResponseDiv.textContent = `Successo! ${result.message}`;
                    txResponseDiv.className = 'response success';
                } catch (error) {
                    txResponseDiv.textContent = `Errore: ${error.message}`;
                    txResponseDiv.className = 'response error';
                }
            });

        logoutButton.addEventListener('click', async () => {
                try {
                    await fetch('/logout', { method: 'POST' });
                } catch (error) {
                    console.error("Errore durante il logout:", error);
                } finally {
                    // A prescindere dal successo della chiamata, ricarichiamo la pagina
                    location.reload();
                }
        });

    </script>
</body>

</html>

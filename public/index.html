<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PrimeGenesis</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --primary-color: #9945FF;
            --text-color: #FFFFFF;
            --text-secondary: #AAAAAA;
            --border-color: #333333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .main-wrapper {
            width: 100%;
            max-width: 500px;
            margin-bottom: 10vh;
        }
        .container {
            background-color: var(--surface-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        h1, h2 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--border-color);
            color: var(--text-color);
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 14px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #7a37cc; }
        .welcome-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #logoutButton { background-color: #444; width: auto; padding: 8px 16px; font-size: 14px; margin-top: 0; }
        .response { margin-top: 20px; padding: 12px; border-radius: 8px; display: none; text-align: center; }
        .success { background-color: rgba(40, 167, 69, 0.2); color: #28a745; }
        .error { background-color: rgba(220, 53, 69, 0.2); color: #dc3545; }

        /* --- NUOVI STILI PER IL WALLET --- */
        .wallet-info {
            background-color: var(--border-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 5px;
        }
        .wallet-address-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .wallet-address {
            font-family: monospace;
            font-size: 14px;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .wallet-actions {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }
        .wallet-icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            margin: 0;
            transition: color 0.2s;
        }
        .wallet-icon-btn:hover { color: var(--primary-color); }
    </style>
</head>
<body>

    <!-- Sezione di Login (visibile di default) -->
    <div class="main-wrapper">
        <!-- Sezione di Login -->
        <div id="login-section" class="container">
            <h1>Dashboard Login</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginIdentifier">Email o Username</label>
                    <input type="text" id="loginIdentifier" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit">Accedi</button>
            </form>
            <div id="login-response" class="response"></div>
        </div>
    
        <!-- Sezione Transazione -->
        <div id="transaction-section" class="container" style="display: none;">
            <div class="welcome-container">
                <h2 style="text-align: left; margin: 0;">Dashboard</h2>
                <button type="button" id="logoutButton">Logout</button>
            </div>
            
            <!-- NUOVO BLOCCO PER LE INFO UTENTE E WALLET -->
            <div class="user-info">
                <p id="welcome-message" style="margin-bottom: 5px;"></p>
                <div class="wallet-info">
                    <label>Wallet Associato</label>
                    <div class="wallet-address-container">
                        <span id="wallet-address-short" class="wallet-address"></span>
                        <div class="wallet-actions">
                            <button id="copy-wallet-btn" class="wallet-icon-btn" title="Copia indirizzo">üìã</button>
                            <a id="solscan-link" href="#" target="_blank" class="wallet-icon-btn" title="Vedi su Solscan">‚ÜóÔ∏è</a>
                        </div>
                    </div>
                </div>
            </div>
    
            <h2 style="margin-top: 30px;">Invia Transazione</h2>
            <form id="txForm">
                <input type="hidden" id="userIdentifier">
                <div class="form-group">
                    <label for="recipientIdentifier">Destinatario (Indirizzo, Email o Username)</label>
                    <input type="text" id="recipientIdentifier" placeholder="Es: Bx...yZ oppure utente@mail.com" required>
                </div>
                <div class="form-group">
                    <label for="amount">Importo (in SOL)</label>
                    <input type="number" id="amount" step="0.001" placeholder="Es: 0.1" required>
                </div>
                <button type="submit">Prepara e Invia Richiesta</button>
            </form>
            <div id="tx-response" class="response"></div>
        </div>
    </div>
    
    <script>
        // Riferimenti agli elementi del DOM
        const loginSection = document.getElementById('login-section');
        const txSection = document.getElementById('transaction-section');
        const loginForm = document.getElementById('loginForm');
        const txForm = document.getElementById('txForm');
        const loginResponseDiv = document.getElementById('login-response');
        const txResponseDiv = document.getElementById('tx-response');
        const logoutButton = document.getElementById('logoutButton');

        const copyWalletBtn = document.getElementById('copy-wallet-btn');
        let fullWalletAddress = ''; // Variabile globale per conservare l'indirizzo completo

        /**
         * NUOVA FUNZIONE: Prepara e mostra la UI per l'utente loggato.
         * Questa funzione viene chiamata sia dopo un login riuscito,
         * sia al caricamento della pagina se troviamo un utente nel localStorage.
         */
      

         function showTransactionUI(user) {
            fullWalletAddress = user.publicKey; // Salva l'indirizzo completo
    
            document.getElementById('welcome-message').textContent = `Benvenuto, ${user.firstName}!`;
            
            // Mostra l'indirizzo abbreviato
            const shortAddress = `${user.publicKey.substring(0, 4)}...${user.publicKey.substring(user.publicKey.length - 4)}`;
            document.getElementById('wallet-address-short').textContent = shortAddress;
    
            // Imposta il link a Solscan Devnet
            document.getElementById('solscan-link').href = `https://solscan.io/account/${user.publicKey}?cluster=devnet`;
            
            document.getElementById('userIdentifier').value = user.username;
            loginSection.style.display = 'none';
            txSection.style.display = 'block';
        }
    
        /**
         * NUOVA FUNZIONE: Copia l'indirizzo del wallet negli appunti
         */
        copyWalletBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(fullWalletAddress).then(() => {
                alert('Indirizzo del wallet copiato!');
            }).catch(err => {
                console.error('Errore durante la copia:', err);
                alert('Impossibile copiare l\'indirizzo.');
            });
        });

        
        // --- LOGICA DI CARICAMENTO PAGINA (MODIFICATA) USA COOKIE ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Prova a chiamare il nuovo endpoint per verificare la sessione
                const response = await fetch('/check-session');
                if (!response.ok) {
                    // Se la risposta non √® OK (es. 401), l'utente non √® loggato
                    console.log("Sessione non valida o scaduta. Mostro il login.");
                    return;
                }
                // Se la risposta √® OK, l'utente √® loggato
                const result = await response.json();
                console.log("Sessione valida trovata. Mostro la dashboard.");
                showTransactionUI(result.user);
            } catch (error) {
                console.error("Errore nel controllo della sessione:", error);
            }
        });

        // Gestione del form di Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('loginIdentifier').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                // 2. Chiama la funzione per mostrare la UI corretta
                showTransactionUI(result.user);

            } catch (error) {
                loginResponseDiv.textContent = `Errore: ${error.message}`;
                loginResponseDiv.className = 'response error';
                loginResponseDiv.style.display = 'block';
            }
        });

        // Gestione Invio Transazione (non cambia la logica, solo il nome del bottone)
        txForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    recipientIdentifier: document.getElementById('recipientIdentifier').value,
                    amount: document.getElementById('amount').value,
                };

                txResponseDiv.textContent = 'Invio richiesta in corso...';
                txResponseDiv.className = 'response';
                txResponseDiv.style.display = 'block';

                try {
                    const response = await fetch('/send-transaction-fcm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data) // Inviamo recipientIdentifier
                    });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.message);

                    txResponseDiv.textContent = `Successo! ${result.message}`;
                    txResponseDiv.className = 'response success';
                } catch (error) {
                    txResponseDiv.textContent = `Errore: ${error.message}`;
                    txResponseDiv.className = 'response error';
                }
            });

        logoutButton.addEventListener('click', async () => {
                try {
                    await fetch('/logout', { method: 'POST' });
                } catch (error) {
                    console.error("Errore durante il logout:", error);
                } finally {
                    // A prescindere dal successo della chiamata, ricarichiamo la pagina
                    location.reload();
                }
        });

    </script>
</body>

</html>

<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PrimeGenesis</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --primary-color: #9945FF;
            --text-color: #FFFFFF;
            --text-secondary: #AAAAAA;
            --error-color: #D32F2F;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; background-color: var(--bg-color); color: var(--text-color); }
        .container { background-color: var(--surface-color); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        h1, h2 { text-align: center; color: var(--text-color); border-bottom: 1px solid #333; padding-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-secondary); }
        input { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #333; border-radius: 8px; background-color: #333; color: var(--text-color); font-size: 16px; }
        button { width: 100%; padding: 14px; cursor: pointer; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 15px; transition: background-color 0.2s; }
        button:hover { background-color: #7a37cc; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        #logoutButton { background-color: #444; width: auto; padding: 8px 16px; font-size: 14px; }
        .response { margin-top: 20px; padding: 12px; border-radius: 8px; display: none; }
        .success { background-color: rgba(40, 167, 69, 0.2); color: #28a745; }
        .error { background-color: rgba(220, 53, 69, 0.2); color: #dc3545; }
        .welcome-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* Stili per la lista degli asset */
        #asset-list { list-style: none; padding: 0; margin-top: 20px; }
        .asset-row { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #333; }
        .asset-row:last-child { border-bottom: none; }
        .asset-logo { width: 40px; height: 40px; border-radius: 20px; margin-right: 15px; }
        .asset-info { flex-grow: 1; }
        .asset-name { font-weight: bold; font-size: 16px; }
        .asset-balance { color: var(--text-secondary); font-size: 14px; }
        .asset-send-btn { background-color: #333; padding: 8px 16px; font-size: 14px; margin: 0; width: auto; }
        
        /* Stili per la modale di invio */
        #send-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        #send-modal .container { width: 90%; max-width: 500px; }
    </style>
</head>
<body>

    <!-- Sezione di Login (visibile di default) -->
    <div id="login-section" class="container">
        <h1>Login PrimeGenesis</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginIdentifier">Email o Username</label>
                <input type="text" id="loginIdentifier" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit">Accedi</button>
        </form>
        <div id="login-response" class="response"></div>
    </div>

    <!-- Sezione Transazione (nascosta di default) -->
    <div id="transaction-section" class="container" style="display: none;">
        <div class="welcome-container">
            <h2 style="text-align: left; margin: 0;">Invia Transazione</h2>
            <button type="button" id="logoutButton">Logout</button>
        </div>
        <p id="welcome-message"></p>
        <form id="txForm">
            <input type="hidden" id="userIdentifier">
            <div class="form-group">
                <!-- MODIFICATO: Etichetta e placeholder aggiornati -->
                <label for="recipientIdentifier">Destinatario (Indirizzo Solana, Email o Username)</label>
                <input type="text" id="recipientIdentifier" placeholder="Es: Bx...yZ oppure utente@mail.com" required>
            </div>
            <div class="form-group">
                <label for="amount">Importo (in SOL)</label>
                <input type="number" id="amount" step="0.001" placeholder="Es: 0.1" required>
            </div>
            <button type="submit">Prepara e Invia Richiesta</button>
        </form>
        <div id="tx-response" class="response"></div>
    </div>

    <script>
        // Riferimenti agli elementi del DOM
        const loginSection = document.getElementById('login-section');
        const txSection = document.getElementById('transaction-section');
        const loginForm = document.getElementById('loginForm');
        const txForm = document.getElementById('txForm');
        const loginResponseDiv = document.getElementById('login-response');
        const txResponseDiv = document.getElementById('tx-response');
        const logoutButton = document.getElementById('logoutButton');

        /**
         * NUOVA FUNZIONE: Prepara e mostra la UI per l'utente loggato.
         * Questa funzione viene chiamata sia dopo un login riuscito,
         * sia al caricamento della pagina se troviamo un utente nel localStorage.
         */
        function showTransactionUI(user) {
            // Ora questo funzionerà perché il server invia le proprietà in camelCase
            document.getElementById('welcome-message').textContent = `Benvenuto, ${user.firstName}! Stai inviando dal wallet: ${user.publicKey}`;
            document.getElementById('userIdentifier').value = user.username;
            loginSection.style.display = 'none';
            txSection.style.display = 'block';
        }

        
        // --- LOGICA DI CARICAMENTO PAGINA (MODIFICATA) USA COOKIE ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Prova a chiamare il nuovo endpoint per verificare la sessione
                const response = await fetch('/check-session');
                if (!response.ok) {
                    // Se la risposta non è OK (es. 401), l'utente non è loggato
                    console.log("Sessione non valida o scaduta. Mostro il login.");
                    return;
                }
                // Se la risposta è OK, l'utente è loggato
                const result = await response.json();
                console.log("Sessione valida trovata. Mostro la dashboard.");
                showTransactionUI(result.user);
            } catch (error) {
                console.error("Errore nel controllo della sessione:", error);
            }
        });

        // Gestione del form di Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('loginIdentifier').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                // 2. Chiama la funzione per mostrare la UI corretta
                showTransactionUI(result.user);

            } catch (error) {
                loginResponseDiv.textContent = `Errore: ${error.message}`;
                loginResponseDiv.className = 'response error';
                loginResponseDiv.style.display = 'block';
            }
        });

        // Gestione Invio Transazione (non cambia la logica, solo il nome del bottone)
        txForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    recipientIdentifier: document.getElementById('recipientIdentifier').value,
                    amount: document.getElementById('amount').value,
                };

                txResponseDiv.textContent = 'Invio richiesta in corso...';
                txResponseDiv.className = 'response';
                txResponseDiv.style.display = 'block';

                try {
                    const response = await fetch('/send-transaction-fcm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data) // Inviamo recipientIdentifier
                    });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.message);

                    txResponseDiv.textContent = `Successo! ${result.message}`;
                    txResponseDiv.className = 'response success';
                } catch (error) {
                    txResponseDiv.textContent = `Errore: ${error.message}`;
                    txResponseDiv.className = 'response error';
                }
            });

        logoutButton.addEventListener('click', async () => {
                try {
                    await fetch('/logout', { method: 'POST' });
                } catch (error) {
                    console.error("Errore durante il logout:", error);
                } finally {
                    // A prescindere dal successo della chiamata, ricarichiamo la pagina
                    location.reload();
                }
        });

    </script>
</body>

</html>
